{% extends 'frontend/base.html' %}
{% load static %}

{% block page_title %}Nueva Venta{% endblock %}

{% block frontend_extra_css %}
<style>
    .sale-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .product-search {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .cart-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .cart-item:hover {
        background: #e9ecef;
    }
    
    .quantity-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .quantity-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quantity-btn:hover:not(:disabled) {
        background: #e9ecef;
    }
    
    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .quantity-input {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.9rem;
        padding: 4px 8px;
        text-align: center;
        background: white;
    }
    
    .quantity-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }
    
    .discount-control {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .discount-control .input-group {
        max-width: 100px;
    }
    
    .discount-control .form-control {
        text-align: center;
        font-weight: bold;
    }
    
    .discount-control .input-group-text {
        background: #f8f9fa;
        border-color: #dee2e6;
        font-size: 0.875rem;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
    }
    
    .summary-card .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: bold;
    }
    
    .summary-card .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
    }
    
    .summary-card .form-control::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .summary-card .input-group-text {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    /* Estilos para el resumen de venta */
    .summary-breakdown {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .summary-row:last-child {
        border-bottom: none;
    }
    
    .summary-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .summary-value {
        color: white;
        font-weight: bold;
        font-size: 1rem;
    }
    
    .summary-value.text-danger {
        text-shadow: 
            -1px -1px 0 rgba(255, 255, 255, 0.3),
            1px -1px 0 rgba(255, 255, 255, 0.3),
            -1px 1px 0 rgba(255, 255, 255, 0.3),
            1px 1px 0 rgba(255, 255, 255, 0.3);
        font-weight: 900;
        letter-spacing: 0.5px;
    }
    
    .discount-row {
        background: rgba(220, 53, 69, 0.1);
        margin: 0 -0.5rem;
        padding: 0.5rem;
        border-radius: 5px;
        border: 2px solid rgba(220, 53, 69, 0.4);
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.2);
    }
    
    .total-discount-row {
        background: rgba(220, 53, 69, 0.15);
        margin: 0 -0.5rem;
        padding: 0.5rem;
        border-radius: 5px;
        border: 2px solid rgba(220, 53, 69, 0.6);
        box-shadow: 0 0 8px rgba(220, 53, 69, 0.3);
        font-weight: bold;
    }
    
    .summary-row.total-discount-row .summary-label {
        color: rgba(255, 255, 255, 0.9);
        font-weight: bold;
    }
    
    .discount-row:hover {
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.6);
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.4);
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }
    
    .total-discount-row:hover {
        background: rgba(220, 53, 69, 0.25);
        border-color: rgba(220, 53, 69, 0.8);
        box-shadow: 0 0 12px rgba(220, 53, 69, 0.5);
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }
    
    .search-results {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        background: white;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .search-result-item:hover {
        background: #f8f9fa;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .barcode-scanner {
        background: #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    /* Responsive para carrito */
    @media (max-width: 767.98px) {
        .cart-item .row {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .cart-item .col-md-3,
        .cart-item .col-md-2 {
            width: 100%;
            text-align: center;
        }
        
        .cart-item .quantity-control,
        .cart-item .discount-control {
            justify-content: center;
        }
        
        .cart-item .row.text-center {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        
        .cart-item .col-4 {
            flex: 1;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block frontend_content %}
<div class="container-fluid">
    <!-- CSRF Token -->
    {% csrf_token %}
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Nueva Venta</h1>
        <div class="d-flex gap-2">
            <a href="{% url 'frontend:sales_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
            <button type="button" class="btn btn-outline-info" onclick="printTicket()">
                <i class="fas fa-print me-2"></i>Imprimir
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Panel izquierdo - Productos y carrito -->
        <div class="col-lg-8">
            <div class="sale-container p-4">
                <!-- Información de la caja -->
                <div class="alert alert-info mb-4">
                    <i class="fas fa-cash-register me-2"></i>
                    <strong>Caja:</strong> {{ current_cashbox.user.get_full_name|default:current_cashbox.user.username }}
                    <span class="ms-3">
                        <i class="fas fa-clock me-1"></i>
                        Abierta: {{ current_cashbox.opened_at|date:"H:i" }}
                    </span>
                </div>

                <!-- Búsqueda de productos -->
                <div class="product-search">
                    <h5 class="mb-3">
                        <i class="fas fa-search me-2"></i>
                        Buscar Productos
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <input type="text" class="form-control form-control-lg" id="productSearch" 
                                       placeholder="Buscar por nombre o código de barras..."
                                       onfocus="this.select()">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="focusBarcodeScanner()">
                                <i class="fas fa-barcode me-2"></i>Escanear Código
                            </button>
                        </div>
                    </div>
                    
                    <!-- Escáner de código de barras -->
                    <div class="barcode-scanner" id="barcodeScanner" style="display: none;">
                        <h6 class="mb-2">Escáner de Código de Barras</h6>
                        <input type="text" class="form-control" id="barcodeInput" 
                               placeholder="Coloca el cursor aquí y escanea el código..."
                               onfocus="this.select()">
                        <small class="text-muted">Presiona Enter para buscar</small>
                    </div>
                </div>

                <!-- Carrito de compras -->
                <div class="cart-section">
                    <h5 class="mb-3">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Carrito de Compras
                    </h5>
                    
                    <div id="cartItems">
                        <!-- Los items del carrito se agregarán aquí dinámicamente -->
                    </div>
                    
                    <div id="emptyCart" class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Carrito vacío</h5>
                        <p class="text-muted">Busca productos para agregarlos al carrito</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel derecho - Resumen y pago -->
        <div class="col-lg-4">
            <div class="summary-card">
                <h5 class="mb-3">
                    <i class="fas fa-receipt me-2"></i>
                    Resumen de Venta
                </h5>
                
                <!-- Resumen de montos -->
                <div class="summary-breakdown mb-3">
                    <div class="summary-row">
                        <div class="summary-label">Subtotal</div>
                        <div class="summary-value" id="subtotal">$0</div>
                    </div>
                    
                                         <!-- Descuentos individuales -->
                     <div class="summary-row discount-row" id="itemsDiscountRow" style="display: none;">
                         <div class="summary-label">
                             <i class="fas fa-tag me-1"></i>Descuentos productos
                         </div>
                         <div class="summary-value text-danger" id="itemsDiscountDisplay">-$0</div>
                     </div>
                    
                    <!-- Subtotal después de descuentos individuales -->
                    <div class="summary-row" id="subtotalAfterDiscountsRow" style="display: none;">
                        <div class="summary-label">Subtotal después de descuentos</div>
                        <div class="summary-value" id="subtotalAfterDiscounts">$0</div>
                    </div>
                    
                                         <!-- Descuento general -->
                     <div class="summary-row discount-row" id="saleDiscountRow" style="display: none;">
                         <div class="summary-label">
                             <i class="fas fa-percentage me-1"></i>Descuento general
                         </div>
                         <div class="summary-value text-danger" id="saleDiscountDisplay">-$0</div>
                     </div>
                    
                                         <!-- Total de descuentos -->
                     <div class="summary-row total-discount-row" id="totalDiscountRow" style="display: none;">
                         <div class="summary-label">Total descuentos</div>
                         <div class="summary-value text-danger" id="totalDiscount">-$0</div>
                     </div>
                </div>
                
                <!-- Descuento general de la venta -->
                <div class="mb-3">
                    <label class="form-label text-white">
                        <i class="fas fa-percentage me-1"></i>Descuento General
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="saleDiscount" 
                               min="0" max="100" step="0.1" value="0"
                               onchange="updateSaleDiscount(this.value)"
                               onfocus="this.select()"
                               placeholder="0">
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="text-white-50 small mt-1">
                        <div class="d-flex justify-content-between">
                            <span>Monto descuento:</span>
                            <span id="saleDiscountAmount">$0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            Se aplica sobre el subtotal después de descuentos individuales
                        </small>
                    </div>
                </div>
                
                <hr class="border-white">
                
                <!-- Total editable -->
                <div class="mb-4">
                    <label class="form-label text-white">
                        <i class="fas fa-dollar-sign me-1"></i>Total Final
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control form-control-lg" id="totalFinalEditable" 
                               min="0" step="0.01" value="0"
                               onchange="updateTotalFromAmount(this.value)"
                               onfocus="this.select()"
                               placeholder="0.00">
                    </div>
                    <div class="text-white-50 small mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Total calculado: <span id="totalFinalDisplay">$0</span></span>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="resetToCalculatedTotal()" 
                                    title="Restaurar al total calculado automáticamente">
                                <i class="fas fa-undo me-1"></i>Restaurar
                            </button>
                        </div>
                        <small class="text-white-50 d-block mt-1">
                            <i class="fas fa-edit me-1"></i>
                            Edita el total para ajustar el descuento automáticamente
                        </small>
                    </div>
                </div>
                
                <hr class="border-white my-4">
                
                <!-- Método de pago -->
                <div class="mb-3">
                    <label class="form-label text-white">Método de Pago</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="efectivo">Efectivo</option>
                        <option value="debito">Débito</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="credito">Tarjeta de Crédito</option>
                        <option value="qr">QR</option>
                    </select>
                </div>
                
                <!-- Notas -->
                <div class="mb-4">
                    <label class="form-label text-white">Notas (opcional)</label>
                    <textarea class="form-control" id="notes" rows="2" 
                              placeholder="Notas adicionales..."></textarea>
                </div>
                
                <!-- Botones de acción -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-light btn-lg" onclick="completeSale()" id="completeSaleBtn" disabled>
                        <i class="fas fa-check me-2"></i>Completar Venta
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="clearCart()">
                        <i class="fas fa-trash me-2"></i>Limpiar Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirmar Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres completar esta venta?</p>
                <div class="alert alert-info">
                    <strong>Total:</strong> <span id="confirmTotal">$0</span><br>
                    <strong>Método de pago:</strong> <span id="confirmPayment">Efectivo</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmSale()">
                    <i class="fas fa-check me-2"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block frontend_extra_js %}
<script>
let cart = [];
let searchTimeout;

// Búsqueda de productos
document.getElementById('productSearch').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        hideSearchResults();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        searchProducts(query);
    }, 3000);
});

function searchProducts(query) {
    fetch(`{% url 'frontend:api_search_products' %}?search=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            showSearchResults(data.products);
        })
        .catch(error => {
            console.error('Error searching products:', error);
        });
}

function showSearchResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (products.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item text-muted">No se encontraron productos</div>';
    } else {
        resultsDiv.innerHTML = products.map(product => `
            <div class="search-result-item" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, ${product.stock})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${product.name}</div>
                        <div class="small text-muted">${product.barcode || 'Sin código'}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">$${product.price}</div>
                        <div class="small text-muted">Stock: ${product.stock}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    resultsDiv.style.display = 'block';
}

function hideSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
}

// Click fuera para ocultar resultados
document.addEventListener('click', function(e) {
    if (!e.target.closest('#productSearch') && !e.target.closest('#searchResults')) {
        hideSearchResults();
    }
});

// Agregar al carrito
function addToCart(productId, name, price, stock) {
    // Verificar si ya está en el carrito
    const existingItem = cart.find(item => item.productId === productId);
    
    if (existingItem) {
        if (existingItem.quantity < stock) {
            existingItem.quantity++;
        } else {
            alert('No hay suficiente stock disponible');
            return;
        }
    } else {
        if (stock <= 0) {
            alert('Este producto no tiene stock disponible');
            return;
        }
        
        cart.push({
            productId: productId,
            name: name,
            price: price,
            stock: stock,
            quantity: 1,
            discount: 0
        });
    }
    
    updateCartDisplay();
    hideSearchResults();
    document.getElementById('productSearch').value = '';
}

// Actualizar display del carrito
function updateCartDisplay() {
    const cartDiv = document.getElementById('cartItems');
    const emptyDiv = document.getElementById('emptyCart');
    
    if (cart.length === 0) {
        cartDiv.style.display = 'none';
        emptyDiv.style.display = 'block';
        document.getElementById('completeSaleBtn').disabled = true;
    } else {
        cartDiv.style.display = 'block';
        emptyDiv.style.display = 'none';
        document.getElementById('completeSaleBtn').disabled = false;
        
        cartDiv.innerHTML = cart.map((item, index) => {
            const subtotal = item.price * item.quantity;
            const discountAmount = subtotal * (item.discount / 100);
            const total = subtotal - discountAmount;
            
            return `
            <div class="cart-item">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="fw-bold">${item.name}</div>
                        <div class="small text-muted">$${item.price} c/u</div>
                    </div>
                    <div class="col-md-2">
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(${index}, -1)" ${item.quantity <= 0.01 ? 'disabled' : ''}>-</button>
                            <input type="number" class="form-control quantity-input" 
                                   value="${item.quantity}" 
                                   min="0.01" max="${item.stock}" 
                                   step="0.01"
                                   onchange="changeQuantityManual(${index}, this.value)"
                                   onblur="validateQuantity(${index}, this.value)"
                                   onfocus="this.select()"
                                   style="width: 70px; text-align: center; display: inline-block; margin: 0 5px;">
                            <button type="button" class="quantity-btn" onclick="changeQuantity(${index}, 1)" ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="discount-control">
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" 
                                       value="${item.discount}" 
                                       min="0" max="100" step="1"
                                       onchange="changeDiscount(${index}, this.value)"
                                       onfocus="this.select()"
                                       placeholder="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="small text-muted">Subtotal</div>
                                <div class="fw-bold">$${subtotal.toFixed(0)}</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Descuento</div>
                                <div class="fw-bold ${item.discount > 0 ? 'text-success' : 'text-muted'}">${item.discount > 0 ? '-$' + discountAmount.toFixed(0) : '$0'}</div>
                            </div>
                            <div class="col-4">
                                <div class="small text-muted">Total</div>
                                <div class="fw-bold">$${total.toFixed(0)}</div>
                            </div>
                        </div>
                        ${item.discount > 0 ? `<div class="small text-success text-center mt-1">-${item.discount}%</div>` : ''}
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }
    
    updateSummary();
}

// Cambiar cantidad
function changeQuantity(index, change) {
    const item = cart[index];
    const newQuantity = parseFloat((item.quantity + change).toFixed(2));
    
    if (newQuantity > 0 && newQuantity <= item.stock) {
        item.quantity = newQuantity;
        updateCartDisplay();
    }
}

// Cambiar cantidad manualmente
function changeQuantityManual(index, newQuantity) {
    const item = cart[index];
    const quantity = parseFloat(newQuantity) || 0.01;
    
    if (quantity > 0 && quantity <= item.stock) {
        item.quantity = quantity;
        updateCartDisplay();
    } else if (quantity > item.stock) {
        alert(`No hay suficiente stock. Máximo disponible: ${item.stock}`);
        item.quantity = item.stock;
        updateCartDisplay();
    } else if (quantity <= 0) {
        alert('La cantidad debe ser mayor a 0');
        item.quantity = 0.01;
        updateCartDisplay();
    }
}

// Validar cantidad al perder el foco
function validateQuantity(index, newQuantity) {
    const item = cart[index];
    const quantity = parseFloat(newQuantity) || 0.01;
    
    if (quantity > item.stock) {
        alert(`No hay suficiente stock. Máximo disponible: ${item.stock}`);
        item.quantity = item.stock;
        updateCartDisplay();
    } else if (quantity <= 0) {
        alert('La cantidad debe ser mayor a 0');
        item.quantity = 0.01;
        updateCartDisplay();
    }
}

// Cambiar descuento
function changeDiscount(index, discount) {
    const item = cart[index];
    const newDiscount = parseFloat(discount) || 0;
    
    if (newDiscount >= 0 && newDiscount <= 100) {
        item.discount = newDiscount;
        updateCartDisplay();
    } else {
        alert('El descuento debe estar entre 0% y 100%');
        // Restaurar el valor anterior
        updateCartDisplay();
    }
}

// Remover del carrito
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

// Actualizar descuento general de la venta
function updateSaleDiscount(discount) {
    const newDiscount = parseFloat(discount) || 0;
    
    if (newDiscount >= 0 && newDiscount <= 100) {
        updateSummary();
    } else {
        alert('El descuento debe estar entre 0% y 100%');
        document.getElementById('saleDiscount').value = 0;
        updateSummary();
    }
}

// Actualizar resumen
function updateSummary() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const itemsDiscount = cart.reduce((sum, item) => sum + (item.price * item.quantity * item.discount / 100), 0);
    
    // Subtotal después de descuentos individuales
    const subtotalAfterItemsDiscount = subtotal - itemsDiscount;
    
    // Descuento general de la venta (sobre el subtotal después de descuentos individuales)
    const saleDiscountPercentage = parseFloat(document.getElementById('saleDiscount').value) || 0;
    const saleDiscountAmount = (subtotalAfterItemsDiscount * saleDiscountPercentage) / 100;
    
    // Total de descuentos
    const totalDiscount = itemsDiscount + saleDiscountAmount;
    const totalFinal = subtotal - totalDiscount;
    
    // Actualizar valores principales
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(0)}`;
    document.getElementById('totalFinalDisplay').textContent = `$${totalFinal.toFixed(0)}`;
    document.getElementById('saleDiscountAmount').textContent = `$${saleDiscountAmount.toFixed(0)}`;
    
    // Mostrar/ocultar filas según corresponda
    const itemsDiscountRow = document.getElementById('itemsDiscountRow');
    const subtotalAfterDiscountsRow = document.getElementById('subtotalAfterDiscountsRow');
    const saleDiscountRow = document.getElementById('saleDiscountRow');
    const totalDiscountRow = document.getElementById('totalDiscountRow');
    
    // Descuentos individuales
    if (itemsDiscount > 0) {
        itemsDiscountRow.style.display = 'flex';
        document.getElementById('itemsDiscountDisplay').textContent = `-$${itemsDiscount.toFixed(0)}`;
        document.getElementById('itemsDiscountDisplay').className = 'summary-value text-danger';
        
        // Subtotal después de descuentos individuales
        subtotalAfterDiscountsRow.style.display = 'flex';
        document.getElementById('subtotalAfterDiscounts').textContent = `$${subtotalAfterItemsDiscount.toFixed(0)}`;
    } else {
        itemsDiscountRow.style.display = 'none';
        subtotalAfterDiscountsRow.style.display = 'none';
    }
    
    // Descuento general
    if (saleDiscountAmount > 0) {
        saleDiscountRow.style.display = 'flex';
        document.getElementById('saleDiscountDisplay').textContent = `-$${saleDiscountAmount.toFixed(0)}`;
        document.getElementById('saleDiscountDisplay').className = 'summary-value text-danger';
    } else {
        saleDiscountRow.style.display = 'none';
    }
    
    // Total de descuentos
    if (totalDiscount > 0) {
        totalDiscountRow.style.display = 'flex';
        document.getElementById('totalDiscount').textContent = `-$${totalDiscount.toFixed(0)}`;
        document.getElementById('totalDiscount').className = 'summary-value text-danger';
    } else {
        totalDiscountRow.style.display = 'none';
    }
    
    // Actualizar el campo editable solo si no ha sido modificado manualmente
    const totalFinalEditable = document.getElementById('totalFinalEditable');
    if (!totalFinalEditable.dataset.manuallyEdited) {
        totalFinalEditable.value = totalFinal.toFixed(2);
    }
}

// Actualizar total desde monto ingresado
function updateTotalFromAmount(amount) {
    const newTotal = parseFloat(amount) || 0;
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const itemsDiscount = cart.reduce((sum, item) => sum + (item.price * item.quantity * item.discount / 100), 0);
    const subtotalAfterItemsDiscount = subtotal - itemsDiscount;
    
    if (newTotal > subtotal) {
        alert('El total no puede ser mayor al subtotal');
        updateSummary();
        return;
    }
    
    if (newTotal < 0) {
        alert('El total no puede ser negativo');
        updateSummary();
        return;
    }
    
    // Calcular el descuento total necesario
    const totalDiscountNeeded = subtotal - newTotal;
    const saleDiscountNeeded = totalDiscountNeeded - itemsDiscount;
    
    // Calcular el porcentaje de descuento general (sobre el subtotal después de descuentos individuales)
    let saleDiscountPercentage = 0;
    if (subtotalAfterItemsDiscount > 0 && saleDiscountNeeded > 0) {
        saleDiscountPercentage = (saleDiscountNeeded / subtotalAfterItemsDiscount) * 100;
    }
    
    // Si el descuento es muy alto, mostrar advertencia
    if (saleDiscountPercentage > 100) {
        alert('El descuento general sería mayor al 100%. Verifica los valores.');
        updateSummary();
        return;
    }
    
    // Marcar como editado manualmente
    document.getElementById('totalFinalEditable').dataset.manuallyEdited = 'true';
    
    // Actualizar el descuento general
    document.getElementById('saleDiscount').value = saleDiscountPercentage.toFixed(2);
    
    // Actualizar display
    document.getElementById('totalFinalDisplay').textContent = `$${newTotal.toFixed(0)}`;
    document.getElementById('saleDiscountAmount').textContent = `$${saleDiscountNeeded.toFixed(0)}`;
    
    // Mostrar/ocultar filas según corresponda
    const itemsDiscountRow = document.getElementById('itemsDiscountRow');
    const subtotalAfterDiscountsRow = document.getElementById('subtotalAfterDiscountsRow');
    const saleDiscountRow = document.getElementById('saleDiscountRow');
    const totalDiscountRow = document.getElementById('totalDiscountRow');
    
    // Descuentos individuales
    if (itemsDiscount > 0) {
        itemsDiscountRow.style.display = 'flex';
        document.getElementById('itemsDiscountDisplay').textContent = `-$${itemsDiscount.toFixed(0)}`;
        document.getElementById('itemsDiscountDisplay').className = 'summary-value text-danger';
        
        // Subtotal después de descuentos individuales
        subtotalAfterDiscountsRow.style.display = 'flex';
        document.getElementById('subtotalAfterDiscounts').textContent = `$${subtotalAfterItemsDiscount.toFixed(0)}`;
    } else {
        itemsDiscountRow.style.display = 'none';
        subtotalAfterDiscountsRow.style.display = 'none';
    }
    
    // Descuento general
    if (saleDiscountNeeded > 0) {
        saleDiscountRow.style.display = 'flex';
        document.getElementById('saleDiscountDisplay').textContent = `-$${saleDiscountNeeded.toFixed(0)}`;
        document.getElementById('saleDiscountDisplay').className = 'summary-value text-danger';
    } else {
        saleDiscountRow.style.display = 'none';
    }
    
    // Total de descuentos
    if (totalDiscountNeeded > 0) {
        totalDiscountRow.style.display = 'flex';
        document.getElementById('totalDiscount').textContent = `-$${totalDiscountNeeded.toFixed(0)}`;
        document.getElementById('totalDiscount').className = 'summary-value text-danger';
    } else {
        totalDiscountRow.style.display = 'none';
    }
}

// Restaurar al total calculado
function resetToCalculatedTotal() {
    const totalFinalEditable = document.getElementById('totalFinalEditable');
    delete totalFinalEditable.dataset.manuallyEdited;
    updateSummary();
}

// Limpiar carrito
function clearCart() {
    if (confirm('¿Estás seguro de que quieres limpiar el carrito?')) {
        cart = [];
        updateCartDisplay();
        // Limpiar también el campo editable
        document.getElementById('totalFinalEditable').dataset.manuallyEdited = '';
    }
}

// Completar venta
function completeSale() {
    console.log('Función completeSale llamada');
    
    if (cart.length === 0) {
        alert('El carrito está vacío');
        return;
    }
    
    const total = parseFloat(document.getElementById('totalFinalEditable').value) || 0;
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    console.log('Total:', total);
    console.log('Método de pago:', paymentMethod);
    
    // Verificar que los elementos del modal existan antes de intentar modificar su contenido
    const confirmTotalElement = document.getElementById('confirmTotal');
    const confirmPaymentElement = document.getElementById('confirmPayment');
    
    console.log('Buscando elementos del modal...');
    console.log('confirmTotalElement:', confirmTotalElement);
    console.log('confirmPaymentElement:', confirmPaymentElement);
    
    if (!confirmTotalElement) {
        console.error('Elemento confirmTotal no encontrado');
        // Intentar mostrar el modal de todas formas
        try {
            $('#confirmModal').modal('show');
        } catch (error) {
            console.error('Error al mostrar modal:', error);
            alert('Error: No se pudo mostrar el modal de confirmación');
        }
        return;
    }
    
    if (!confirmPaymentElement) {
        console.error('Elemento confirmPayment no encontrado');
        // Intentar mostrar el modal de todas formas
        try {
            $('#confirmModal').modal('show');
        } catch (error) {
            console.error('Error al mostrar modal:', error);
            alert('Error: No se pudo mostrar el modal de confirmación');
        }
        return;
    }
    
    // Actualizar contenido del modal
    confirmTotalElement.textContent = `$${total.toFixed(0)}`;
    confirmPaymentElement.textContent = paymentMethod.charAt(0).toUpperCase() + paymentMethod.slice(1);
    
    console.log('Intentando mostrar modal...');
    
    try {
        // Verificar si jQuery está disponible
        if (typeof $ === 'undefined') {
            console.error('jQuery no está disponible');
            alert('Error: jQuery no está disponible');
            return;
        }
        
        // Verificar si el modal existe
        const modal = document.getElementById('confirmModal');
        if (!modal) {
            console.error('Modal no encontrado');
            alert('Error: Modal de confirmación no encontrado');
            return;
        }
        
        console.log('Modal encontrado, intentando mostrar...');
        
        // Usar jQuery para mostrar el modal
        $('#confirmModal').modal('show');
        
        console.log('Modal mostrado exitosamente');
    } catch (error) {
        console.error('Error al mostrar modal:', error);
        alert('Error al mostrar el modal de confirmación: ' + error.message);
    }
}

// Confirmar venta
function confirmSale() {
    const saleData = {
        payment_method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('notes').value,
        sale_discount_percentage: parseFloat(document.getElementById('saleDiscount').value) || 0,
        total_final: parseFloat(document.getElementById('totalFinalEditable').value) || 0,
        items: cart.map(item => ({
            product_id: item.productId,
            quantity: item.quantity,
            unit_price: item.price,
            discount_percentage: item.discount
        }))
    };
    
    // Mostrar loading
    const btn = document.querySelector('#confirmModal .btn-primary');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
    btn.disabled = true;
    
    fetch('{% url "frontend:sale_create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal
            $('#confirmModal').modal('hide');
            
            // Mostrar mensaje de éxito
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Venta completada exitosamente. Ticket: ${data.ticket_number}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.main-content').prepend(alertHtml);
            
            // Limpiar carrito
            cart = [];
            updateCartDisplay();
            document.getElementById('notes').value = '';
            document.getElementById('totalFinalEditable').dataset.manuallyEdited = '';
            
            // Redirigir al detalle de la venta
            setTimeout(() => {
                window.location.href = `{% url 'frontend:sale_detail' 0 %}`.replace('0', data.sale_id);
            }, 2000);
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        alert('Error al procesar la venta: ' + error.message);
        
        // Restaurar botón
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Escáner de código de barras
function focusBarcodeScanner() {
    const scanner = document.getElementById('barcodeScanner');
    const input = document.getElementById('barcodeInput');
    
    if (scanner.style.display === 'none') {
        scanner.style.display = 'block';
        input.focus();
    } else {
        scanner.style.display = 'none';
        input.value = '';
    }
}

document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const barcode = this.value.trim();
        if (barcode) {
            // Buscar producto por código de barras
            fetch(`{% url 'frontend:api_product_by_barcode' 'PLACEHOLDER' %}`.replace('PLACEHOLDER', barcode))
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        addToCart(data.id, data.name, data.price, data.stock);
                    } else {
                        alert('Producto no encontrado');
                    }
                })
                .catch(error => {
                    alert('Error al buscar el producto');
                });
            
            this.value = '';
            this.focus();
        }
    }
});

// Imprimir ticket
function printTicket() {
    if (cart.length === 0) {
        alert('No hay productos en el carrito para imprimir');
        return;
    }
    
    // Aquí iría la lógica de impresión
    alert('Función de impresión en desarrollo');
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, verificando elementos...');
    
    // Verificar elementos críticos
    const elements = {
        'productSearch': document.getElementById('productSearch'),
        'searchResults': document.getElementById('searchResults'),
        'cartItems': document.getElementById('cartItems'),
        'emptyCart': document.getElementById('emptyCart'),
        'completeSaleBtn': document.getElementById('completeSaleBtn'),
        'confirmModal': document.getElementById('confirmModal'),
        'confirmTotal': document.getElementById('confirmTotal'),
        'confirmPayment': document.getElementById('confirmPayment'),
        'paymentMethod': document.getElementById('paymentMethod'),
        'subtotal': document.getElementById('subtotal'),
        'totalDiscount': document.getElementById('totalDiscount'),
        'totalFinal': document.getElementById('totalFinal')
    };
    
    // Verificar que todos los elementos existan
    for (const [name, element] of Object.entries(elements)) {
        if (!element) {
            console.error(`Elemento ${name} no encontrado`);
        } else {
            console.log(`Elemento ${name} encontrado`);
        }
    }
    
    // Verificar jQuery
    if (typeof $ === 'undefined') {
        console.error('jQuery no está disponible');
    } else {
        console.log('jQuery está disponible');
    }
    
    // Verificar Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap no está disponible');
    } else {
        console.log('Bootstrap está disponible');
    }
    
    updateCartDisplay();
});

updateCartDisplay();
</script>
{% endblock %} 